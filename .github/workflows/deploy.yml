name: Deploy KFlow Assets

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '**/*.png'
      - '**/*.jpg'
      - '**/*.jpeg'
      - '**/*.webp'
      - '**/*.gif'
      - '**/*.svg'
      - '**/*.glb'
      - '**/*.gltf'
      - '**/*.mp3'
      - '**/*.ogg'
      - '**/*.wav'
      - '**/*.mp4'
      - '**/*.pdf'
      - '**/manifest.json'
      - 'firebase.json'

jobs:
  deploy:
    name: Deploy to Firebase Hosting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Verify LFS files are real
        run: |
          SAMPLE=$(find . -name "*.png" -type f | head -1)
          if [ -n "$SAMPLE" ]; then
            if head -1 "$SAMPLE" | grep -q "version https://git-lfs"; then
              echo "::error::LFS files not pulled â€” $SAMPLE is a pointer"
              exit 1
            fi
            echo "LFS verified: $SAMPLE is a real binary"
          fi

      - name: Ensure Firebase site exists
        run: npx firebase-tools hosting:sites:create almadar-kflow-assets --project kflow-b3a39 || true
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: kflow-b3a39
          channelId: live
          target: kflow-assets
